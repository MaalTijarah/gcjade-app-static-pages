<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shipping Address</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    body {
      padding: 1rem;
    }

    .select2-container--bootstrap-5 .select2-selection {
      border-radius: 0.375rem !important;
      /* Bootstrap default */
      min-height: 38px;
      padding: 0.30rem;  /*0.75rem; */
      border: 1px solid #ced4da;
      background-color: #fff;
    }

    .select2-container--bootstrap-5 .select2-selection__arrow {
      height: 38px;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 30px;
      position: absolute;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .select2-container--bootstrap-5 .select2-selection__arrow b {
      border: none;
      width: 1em;
      height: 1em;
      display: block;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="%236c757d" stroke-width="2.0" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 16 16"><polyline points="4 6 8 10 12 6"/></svg>') no-repeat center center;
      background-size: 1em 1em;
      margin: 0 auto;
    }

    /* Ensure selection is relative for arrow positioning */
    .select2-container--bootstrap-5 .select2-selection {
      position: relative;
    }

    /* Fix for focus state */
    .select2-container--bootstrap-5.select2-container--focus .select2-selection {
      border-color: #86b7fe !important;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25);
    }

    .btn-custom-submit {
      background-color: #00A86B !important;
      border-color: #00A86B !important;
      color: #fff !important;
    }

    .btn-custom-submit:hover, .btn-custom-submit:focus {
      background-color: #008f5a !important;
      border-color: #008f5a !important;
      color: #fff !important;
    }
  </style>
</head>

<body>
  <div class="container">
    <h4 class="mb-4">Shipping Address</h4>
    <form>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="country" class="form-label">Country</label>
          <select class="form-select" id="country" name="country">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="state" class="form-label">State</label>
          <select class="form-select" id="state" name="state" disabled>
            <option value="">Select Country First</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="city" class="form-label">City</label>
          <select class="form-select" id="city" name="city" disabled>
            <option value="">Select State First</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="zip" class="form-label">ZIP / Postal Code</label>
          <input type="text" class="form-control" id="zip" name="zip" placeholder="ZIP or Postal Code" />
        </div>
        <div class="col-12">
          <label for="address1" class="form-label">Address Line 1</label>
          <textarea class="form-control" id="address1" name="address1" rows="2" placeholder="Street address, P.O. box, company name, c/o"></textarea>
        </div>
        <div class="col-12">
          <label for="address2" class="form-label">Address Line 2</label>
          <textarea class="form-control" id="address2" name="address2" rows="2" placeholder="Apartment, suite, unit, building, floor, etc."></textarea>
        </div>
        <div class="col-12 text-end">
          <button type="button" class="btn btn-custom-submit mt-3" onclick="submitForm()">Submit</button>
        </div>
      </div>
    </form>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.js"></script>

  <script>
    // Example API endpoints (replace with your real endpoints)
    const API_COUNTRIES = 'https://restcountries.com/v3.1/all?fields=name';
    const API_STATES = 'https://countriesnow.space/api/v0.1/countries/states';
    const API_CITIES = 'https://countriesnow.space/api/v0.1/countries/state/cities';

    function fetchCountries() {
      $.get(API_COUNTRIES, function(data) {
        const $country = $('#country');
        $country.empty().append('<option value="">Select Country</option>');
        data.sort((a, b) => a.name.common.localeCompare(b.name.common));
        data.forEach(country => {
          $country.append(`<option value="${country.name.common}">${country.name.common}</option>`);
        });
        $country.prop('disabled', false);
      });
    }

    function fetchStates(country) {
      const $state = $('#state');
      const $city = $('#city');
      $state.empty().append('<option value="">Loading...</option>').prop('disabled', true);
      $city.empty().append('<option value="">Select State First</option>').prop('disabled', true);
      $.ajax({
        url: API_STATES,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ country }),
        success: function(res) {
          $state.empty().append('<option value="">Select State</option>');
          if (res.data && res.data.states) {
            res.data.states.forEach(state => {
              $state.append(`<option value="${state.name}">${state.name}</option>`);
            });
            $state.prop('disabled', false);
          }
        }
      });
    }

    function fetchCities(country, state) {
      const $city = $('#city');
      $city.empty().append('<option value="">Loading...</option>').prop('disabled', true);
      $.ajax({
        url: API_CITIES,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ country, state }),
        success: function(res) {
          $city.empty().append('<option value="">Select City</option>');
          if (res.data) {
            res.data.forEach(city => {
              $city.append(`<option value="${city}">${city}</option>`);
            });
            $city.prop('disabled', false);
          }
        }
      });
    }

    $(document).ready(function () {
      fetchCountries();
      $('#country').on('change', function() {
        const country = $(this).val();
        if (country) {
          fetchStates(country);
        } else {
          $('#state').empty().append('<option value="">Select Country First</option>').prop('disabled', true);
          $('#city').empty().append('<option value="">Select State First</option>').prop('disabled', true);
        }
      });
      $('#state').on('change', function() {
        const country = $('#country').val();
        const state = $(this).val();
        if (country && state) {
          fetchCities(country, state);
        } else {
          $('#city').empty().append('<option value="">Select State First</option>').prop('disabled', true);
        }
      });
      // Initialize Select2 after dynamic population
      $('#country, #state, #city').select2({
        theme: 'bootstrap-5',
        width: '100%'
      });
    });

    function showError(input, message) {
      const $input = $(input);
      $input.addClass('is-invalid');
      if ($input.next('.invalid-feedback').length === 0) {
        $input.after(`<div class="invalid-feedback">${message}</div>`);
      } else {
        $input.next('.invalid-feedback').text(message);
      }
    }
    function clearError(input) {
      const $input = $(input);
      $input.removeClass('is-invalid');
      $input.next('.invalid-feedback').remove();
    }

    function submitForm() {
      let valid = true;
      // Clear previous errors
      clearError('#country');
      clearError('#state');
      clearError('#city');
      clearError('#zip');
      clearError('#address1');

      if (!$('#country').val()) {
        showError('#country', 'Country is required.');
        valid = false;
      }
      if (!$('#state').val()) {
        showError('#state', 'State is required.');
        valid = false;
      }
      if (!$('#city').val()) {
        showError('#city', 'City is required.');
        valid = false;
      }
      if (!$('#zip').val()) {
        showError('#zip', 'ZIP / Postal Code is required.');
        valid = false;
      }
      if (!$('#address1').val()) {
        showError('#address1', 'Address Line 1 is required.');
        valid = false;
      }
      if (!valid) return;
      const data = {
        country: $('#country').val(),
        state: $('#state').val(),
        city: $('#city').val(),
        zip: $('#zip').val(),
        address1: $('#address1').val(),
        address2: $('#address2').val(),
      };
      if (window.flutter_inappwebview) {
        window.flutter_inappwebview.callHandler('onFormSubmit', data);
      } else {
        alert('Sending to Flutter: ' + JSON.stringify(data));
      }
    }
    // Remove error on input/select change
    $('#country, #state, #city, #zip, #address1').on('change input', function() {
      clearError(this);
    });
  </script>
</body>

</html>